function GmapsMarkerManager(map,options){this.options=options||{};this.marker_size=new google.maps.Size(16,32);this.setMap(map);this.map=map;this.markers=new Array();this.markers_infowindows=new Array();this.view_port=new Object();this.view_port.cell=new Object();this.view_port.cells=new Array();this.view_port.markers=new Array();this.view_port.cell.width=this.options.cell?(this.options.cell.width||false):this.marker_size.width*3.0;this.view_port.cell.height=this.options.cell?(this.options.cell.height||false):this.marker_size.height*3.0;this.view_port.height=this.map.getDiv().offsetHeight;this.view_port.width=this.map.getDiv().offsetWidth;this.view_port.cols_count=Math.ceil(this.view_port.width/this.view_port.cell.width);this.view_port.rows_count=Math.ceil(this.view_port.height/this.view_port.cell.height);this.initial=true;this.on_zoom=false;this.threshold_zoom=this.options.threshold||12;this.group_icon_src=this.options.icon?(this.options.icon.src||false):false;this.group_icon_shadow=this.options.icon?(this.options.icon.shadow||false):false;this.grid=new Object();this.grid.cells=new Array();this.grid.markers=new Array();}
GmapsMarkerManager.prototype=new google.maps.OverlayView();GmapsMarkerManager.prototype.addMarker=function(marker,infowindow){infowindow=infowindow||false;this.markers.push(marker);this.markers_infowindows.push(infowindow);}
GmapsMarkerManager.prototype.removeMarkerByNumber=function(index){this.markers[index].setMap(null);this.markers.splice(index,1);this.initial=true;this.draw();}
GmapsMarkerManager.prototype.clear=function(remove){for(var i in this.markers){if(typeof this.markers[i]=='object'){this.markers[i].setMap(null);}}
if(remove)this.markers=new Array();}
GmapsMarkerManager.prototype.draw=function(){if(this.initial){this.refresh();}
var me=this;google.maps.event.addListener(this.map,"zoom_changed",function(){me.initial=true;});}
GmapsMarkerManager.prototype.refresh=function(){this.clear();this.clearGroupMarkers();this.buildMapGrid(this.initial);this.checkMarkers(this.markers,this.view_port.cells);this.groupMarkers();this.initial=false;}
GmapsMarkerManager.prototype.clearGroupMarkers=function(remove){for(var i=0;i<this.view_port.markers.length;i++){if(this.view_port.markers[i].alias){this.view_port.markers[i].alias.setMap(null);}}
if(remove){this.view_port.markers=new Array();}
return true;}
GmapsMarkerManager.prototype.buildMapGrid=function(force){force=force||false;this.view_port.cells=this.buildGrid(this.calculateGridOptParams(this.markers));for(var i=0;i<this.view_port.cells.length;i++){if(typeof this.view_port.markers[i]=='undefined'||force){this.view_port.markers[i]=new Object();}}}
GmapsMarkerManager.prototype.calculateGridOptParams=function(markers){this.sanity=this.options.sanity||1.5;var grid_params={start:{x:0-this.view_port.width*this.sanity,y:0-this.view_port.height*this.sanity},end:{x:this.view_port.width+this.view_port.width*this.sanity,y:this.view_port.height+this.view_port.height*this.sanity},cell:{width:this.view_port.cell.width,height:this.view_port.cell.height}}
return grid_params;}
GmapsMarkerManager.prototype.buildGrid=function(params){var cells=new Array();for(var i=params.start.x;i<params.end.x;i+=params.cell.width){for(var j=params.start.y;j<params.end.y;j+=params.cell.height){cells.push(new google.maps.LatLngBounds(this.projection.fromDivPixelToLatLng(new google.maps.Point(i,j+params.cell.height)),this.projection.fromDivPixelToLatLng(new google.maps.Point(i+params.cell.width,j))));}}
return cells;}
GmapsMarkerManager.prototype.checkMarkers=function(markers,cells){for(var i=0;i<cells.length;i++){this.view_port.markers[i].count=0;this.view_port.markers[i].items=new Array();this.view_port.markers[i].bounds=cells[i];for(var j=0;j<markers.length;j++){if(cells[i].contains(markers[j].getPosition())){this.view_port.markers[i].count++;this.view_port.markers[i].items.push(markers[j]);}}}
return true;}
GmapsMarkerManager.prototype.groupMarkers=function(){this.threshold=this.map.getZoom()>=this.threshold_zoom?true:false;var infowindow_baloon=infowindow_baloon||new google.maps.InfoWindow();for(var i=0;i<this.view_port.markers.length;i++){if(this.view_port.markers[i].count&&!this.view_port.markers[i].alias){var me=this;if(this.threshold){for(var j=0;j<this.view_port.markers[i].items.length;j++){this.view_port.markers[i].items[j].setMap(this.map);google.maps.event.addListener(this.view_port.markers[i].items[j],"click",function(){if(me.markers_infowindows[i]){infowindow_baloon.setContent(this.markers_infowindows[i]);infowindow_baloon.open(me.map,this);}});}}else{for(var j=0;j<this.view_port.markers[i].items.length;j++){this.view_port.markers[i].items[j].setMap(null);}
if(this.view_port.markers[i].count==1){this.view_port.markers[i].alias=this.view_port.markers[i].items[0];this.view_port.markers[i].alias.setMap(this.map);google.maps.event.addListener(this.view_port.markers[i].alias,"click",function(){if(me.markers_infowindows[i]){infowindow_baloon.setContent(this.markers_infowindows[i]);infowindow_baloon.open(me.map,this);}});}
else{this.view_port.markers[i].alias=new google.maps.Marker({position:this.view_port.markers[i].items[0].getPosition(),title:this.view_port.markers[i].count.toString()});if(this.group_icon_src)this.view_port.markers[i].alias.setIcon(new google.maps.MarkerImage(this.group_icon_src));if(this.group_icon_shadow)this.view_port.markers[i].alias.setShadow(new google.maps.MarkerImage(this.group_icon_shadow));this.view_port.markers[i].alias.setMap(this.map);}}}}} 